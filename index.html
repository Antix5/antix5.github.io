<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    
    <style>
                body{
                background-color: #fbfbfb;
                font-family: 'consolas', 'courier new', 'courier', monospace;



            }

            .module{


            display: block;
            width: 100%;

            margin-left: auto;
            margin-right: auto;
            background-color: #f2f2f2;
            -webkit-box-shadow: 0px 2px 2px -1px rgba(0, 0, 0, 0.217); 
            box-shadow: 0px 2px 2px -1px rgba(0, 0, 0, 0.22);
            border-radius: 5px;
            margin-bottom: 2em;



            overflow: hidden;





            }

            .module_header{

            display: block;
            background-color: #d1cfde;
            height: 2em;
            }

            .module_header h3{

                font-size: medium;
                font-weight: bold;
                padding:0px;
                margin:0px;
                line-height: 2em;
                padding-left: 1em;


            }

            .delete_module{

            display: inline-block;
            position: absolute;
            right: calc(10% + 1.5em);
            margin-top: -2.15em;
            width: 2em;
            height: 2em;
            background-color: #d1cfde00;
            background-image: url("./cross.svg");
            border: none;
            border-radius: 5px;



            }

            .delete_module:hover{

                filter: invert(100%);
                background-color: #d9c37a;

                cursor: pointer;




            }

            #modulebody{

            margin-top: 3em;


            }

            #centeredbody{

                display: block;
                width: 80%;
                margin-left: auto;
                margin-right: auto;
                margin-top: 1em;
                margin-bottom: 1em;

            }

            .module_content{

                padding: 1em;
            }

            .form-control{

                max-width: calc(100% - 1em);
                min-width: calc(100% - 1em);
                border: none;
                padding : 0.5em;
                margin: none;
                outline: none;



            }

            .selectionbar{

            display: block;
            width: 100%;
            height: 2em;
            background-color: #d1cfde;
            margin-top: -5px;
            -webkit-box-shadow: 0px 2px 2px -1px rgba(0,0,0,0.39); 
            box-shadow: 0px 2px 2px -1px rgba(0,0,0,0.39);
            font-family: 'consolas', 'courier new', 'courier', monospace;





            }

            .formatingbutton{


            width: 2.5em;
            height: 2.2em;
            padding: none;
            margin: none;
            background-color: #d1cfde00;
            border: none;
            border-right: #1e1e1f 1px solid;
            text-align: center;
            line-height: 2em;
            margin-top: 2px;
            font-family: 'consolas', 'courier new', 'courier', monospace;


            }

            .nextbut{

                margin-left: -0.65em;


            }

            .formatingbutton:hover{

                background-color: #d9c37a;
                filter: invert(100%);
                cursor: pointer;

            }

            .download{

            width: 100%;
            height: 3em;
            background-color: #776eae;
            border: none;
            font-size: large;
            color: white;
            font-weight: bold;
            text-align: center;
            font-family: consolas, 'courier new', 'courier', monospace;




            }

            .headtable{

                width: 100%;
                display: block;
                margin-bottom: 2em;




            }

            .headtable tr{

            height: 3em;


            }

            .headtable td{
                width: 50%;
            }

            .headtable td input{

                width: 100%;
                height: 100%;
                border: none;
                outline: none;
                padding: 0.5em;
                margin: 0px;
                font-size: medium;
                font-weight: bold;
                font-family: consolas, 'courier new', 'courier', monospace;
                background-color: #f2f2f2;
                border-radius: 5px;
                -webkit-box-shadow: 0px 2px 2px -1px rgba(0,0,0,0.39); 
                box-shadow: 0px 2px 2px -1px rgba(0,0,0,0.39);



            }

            #descri{
                display: block;
                font-size: 17pt;
                font-weight: bold;
                margin-bottom: 0.5em;
            }


            .headtextsection{

                margin-bottom: 1em;
            }

            .newmoduleandpage{

                display: inline-block;
                width: 10em;
                height: 2em;
                font-size: large;
                font-weight: bold;
                background-color: #f2f2f2;
                -webkit-box-shadow: 0px 2px 2px -1px rgba(0,0,0,0.39); 
                box-shadow: 0px 2px 2px -1px rgba(0,0,0,0.39);
                border-radius: 4px;
                border: none;
                outline: none;
                font-family: 'consolas', 'courier new', 'courier', monospace;

            }



            .newmoduleandpage:hover{

                background-color: #d9c37a;
                filter: invert(100%);
                cursor: pointer;

            }


            #modulechoice{

            display: inline-block;
            width: 10em;
            height: 2em;
            font-size: large;
            font-weight: bold;
            background-color: #f2f2f2;
            -webkit-box-shadow: 0px 2px 2px -1px rgba(0,0,0,0.39); 
            box-shadow: 0px 2px 2px -1px rgba(0,0,0,0.39);
            border-radius: 4px;
            border: none;
            outline: none;
            padding-left: 1em;
            font-family: 'consolas', 'courier new', 'courier', monospace;





            }

            .pagetitle{

            font-size: 17pt;
            margin-bottom: 1em;
            font-family: 'consolas', 'courier new', 'courier', monospace;




            }


            .label-file {
                cursor: pointer;

                display: inline-block;
                width: 10em;
                height: 2em;
                font-size: large;
                font-weight: bold;
                background-color: #f2f2f2;
                -webkit-box-shadow: 0px 2px 2px -1px rgba(0,0,0,0.39); 
                box-shadow: 0px 2px 2px -1px rgba(0,0,0,0.39);
                border-radius: 4px;
                border: none;
                outline: none;
                padding-left: 1em;
                line-height: 2em;
                font-family: 'consolas', 'courier new', 'courier', monospace;





            }

            .label-file:hover {
                background-color: #d9c37a;
                filter: invert(100%);
                cursor: pointer;
            }

            #file-selector {
                display: none;
            }

            .newpagedelete{


            margin-top: -3.75em;


            }
    </style>
    
    <title>Document editor</title>

</head>
<body>

    <div id="centeredbody">

    <h1>Document editor</h1>

    <table class="headtable">
        <tr>
            <td>Nom de l'atelier</td>
            <td><input type="text" id="nom_atelier" placeholder="Atelier d'exemple3"></td>
        </tr>
        <tr>
            <td>Version</td>
            <td><input type="text" id="version" placeholder="0.2.5"></td>
        </tr>
        <tr>
            <td>Image</td>
            <td><input type="text" id="image" placeholder="https://img.freepik.com/vecteurs-libre/dragon-dessine-main_53876-88179.jpg"></td>
        </tr>
    </table>

            <span id="descri">Description</span><br>
            <div class="form-group">
                
                <textarea class="form-control headerzone" id="text" rows="3"></textarea>
            <div class="selectionbar headtextsection">
                    
                        
                            <button class="formatingbutton" onclick="addtext('header','** bold **')">ùôó</button>
                            <button class="formatingbutton nextbut" onclick="addtext('header','_ italic _')">ùò™</button>
                            <button class="formatingbutton nextbut" onclick="addtext('header','‚Ä¢')">‚Ä¢</button>
                        
                    
                </div>
            </div>

    <table class="headtable">
        
        <tr>
            <td>Dur√©e</td>
            <td><input type="text" id="duree" placeholder="2h"></td>
        </tr>
        <tr>
            <td>Niveau minimum</td>
            <td><input type="text" id="niveau_min" placeholder="CE2"></td>
        </tr>
    </table>
    <br>

    <form>
        <select name="module" id="modulechoice">
            <option value="texte">texte</option>
            <option value="image">image</option>
            <option value="video">video</option>
            <option value="question_mot">question_mot</option>
            <option value="question_ouverte">question_ouverte</option>
            <option value="texte_a_trous">texte_a_trous</option>
            <option value="QCU">QCU</option>
            <option value="QCM">QCM</option>
            <option value="colonnes_a_remplir">colonnes_a_remplir</option>
            <option value="dessin">dessin</option>
            <option value="prise_photo">prise_photo</option>
            <option value="prise_video">prise_video</option>
            <option value="calculatrice">calculatrice</option>
            <option value="chronometre">chronometre</option>
            <option value="sondage">sondage</option>
            <option value="resultat_sondage">resultat_sondage</option>
            <option value="synthese">synthese</option>
            <option value="resume_atelier">resume_atelier</option>
            <option value="question_magnetometre">question_magnetometre</option>
            <option value="question_deplacement">question_deplacement</option>
            <option value="question_gyroscope">question_gyroscope</option>
            <option value="question_accelerometre">question_accelerometre</option>
            <option value="glisser_deposer_cible">glisser_deposer_cible</option>
            <option value="glisser_deposer_zone">glisser_deposer_zone</option>
            <option value="titre">titre</option>
            <option value="pause">pause</option>
        </select>
        <input type="button" class="newmoduleandpage" onclick="addmodule()" value="Add module">
        <input type="button" class="newmoduleandpage" onclick="addpage()" value="Add page">
        <label for="file-selector" class="label-file">Choisir un JSON</label>
        <input type="file" id="file-selector" accept=".json">

    </form>

    <script>

        /*

        Tout est format√© sur cette seule page afin de pouvoir transmettre le fichier html plus facilement.
        Par cons√©quent , le code n'est pas super propre ( et tr√®s long )

        */

   

            const modulelist = [];
            let maxid = 0;
            const idlist=[]

            

            function addpage(){

                maxid++;
                idlist.push(maxid);

                modulelist.push({
                            "id" : maxid,
                            "type_module": "newpage"
                        });

                
                let renderedhtml = rendermodules();

                $("#modulebody").html(renderedhtml);


            }

            
            // add a module to the modulelist
            function addmodule() {

                let module = $("#modulechoice").val();

                maxid++;
                idlist.push(maxid);
                
                switch (module) {

                    case "texte":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "texte",
                            "contenu": ""
                        });

                        
                        break;

                    case "image":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "image",
                            "url": "",
                            "echelle": ""

                        });

                    
                    
                        break;

                    case "video":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "video",
                            "url": "",
                            "echelle": ""
                        });

                        
                    
                        break;


                    case "question_mot":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "question_mot",
                            "question": "",
                            "reponse_type": ""
                        });
                        break;

                    case "question_ouverte":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "question_ouverte",
                            "question": "",
                            "nombre_lignes": 1,
                            "reponse_type": ""
                        });
                        break;

                    case "texte_a_trous":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "texte_a_trous",
                            "question": "",
                            "reponse_type": []
                        });
                        break;

                    case "QCU":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "QCU",
                            "question": "",
                            "propositions": [],
                            "reponse_type": ""
                        });
                        break;

                    case "QCM":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "QCM",
                            "question": "",
                            "propositions": [],
                            "reponse_type": []
                        });

                        break;

                    case "colonnes_a_remplir":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "colonnes_a_remplir",
                            "question": "",
                            "colonnes": [],
                            "nombre_lignes": 5
                        });
                        break;

                    case "dessin":

                        modulelist.push({
                            "id" : maxid,
                            "type_module": "dessin",
                            "question": "",
                            "image_arriere_plan": "",
                            "echelle": 1,
                            "reponse_type": ""
                        });
                        break;

                    case "prise_de_photo":

                        modulelist.push({
                            "id" : maxid,
                            "type_module": "prise_de_photo",
                            "contenu": ""
                        });
                        break;

                    case "prise_video":
                            
                            modulelist.push({
                                "id" : maxid,
                                "type_module": "prise_video",
                                "contenu": ""
                            });
                            break;


                    case "calculatrice":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "calculatrice"
                        });
                        break;

                    case "chronometre":

                        modulelist.push({
                            "id" : maxid,
                            "type_module": "chronometre"
                        });
                        break;
                    
                    case "sondage":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "sondage",
                            "question": "",
                            "propositions": []
                        });
                        break;

                    case "resultat_sondage":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "resultat_sondage"
                        });
                        break;

                    case "synthese":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "synthese",
                            "question": "",
                            "nombre_lignes": 1
                        });
                        break;

                    case "resume_atelier":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "resume_atelier"
                        });
                        break;

                    case "question_magnetometre":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "question_magnetometre",
                            "question": "",
                            "reponse_type": ""
                        });
                        break;

                    case "question_deplacement":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "question_deplacement",
                            "question": "",
                            "reponse_type": ""
                        });
                        break;

                    case "question_gyroscope":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "question_gyroscope",
                            "question": "",
                            "reponse_type": ""
                        });
                        break;

                    case "question_accelerometre":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "question_accelerometre",
                            "question": "",
                            "reponse_type": ""
                        });
                        break;

                    case "glisser_deposer_cible":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "glisser_deposer_cible",
                            "question": "",
                            "reponse_type": ""
                        });
                        break;

                    case "newpage":
                        modulelist.push({
                            "id" : maxid,
                            "type_module": "newpage"
                        });
                        break;
                    
                    default:
                        break;


                }

                let renderedhtml = rendermodules();

                $("#modulebody").html(renderedhtml);
                
            }

            function removeblock(id){
                let index = modulelist.findIndex(x => x.id == id);
                modulelist.splice(index, 1);
                let renderedhtml = rendermodules();
                $("#modulebody").html(renderedhtml);
            }

            function addtext(id, text){
                let textarea = $("."+id+"zone");
                textarea.val(textarea.val()+text);

            }


            function rendermodules(savemode = true){

                let modulehtml = "";
                let pages = 1;

                modulelist.forEach(element => {

                    // For each module we add the matching html to the modulehtml variable

                    switch (element.type_module) {

                        case "texte":

                            if(savemode){

                            // We firstly save the value of the textarea already displayed in the module
                            let textarea = $("."+element.id+"zone");
                            element.contenu = textarea.val();

                            }

                            if(element.contenu == undefined){
                                element.contenu = "";
                            }


                            modulehtml += `<div class="module">
                                            <div class="module_header">
                                                <h3>Texte</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>
                      
                                            <div class="module_content">
                                                <div class="form-group">
                
                                                    <textarea class="form-control ${element.id}zone" id="text" rows="3">${element.contenu.replace(/\"/g,"\'\'")}</textarea>
                                                    <div class="selectionbar">
                                                        
                                                            
                                                                <button class="formatingbutton" onclick="addtext('${element.id}','** bold **')">ùôó</button>
                                                                <button class="formatingbutton nextbut" onclick="addtext('${element.id}','_ italic _')">ùò™</button>
                                                                <button class="formatingbutton nextbut" onclick="addtext('${element.id}','‚Ä¢')">‚Ä¢</button>
                                                            
                                                        
                                                    </div>
                                                </div>
                                            </div>
                                        </div>`;

                        
                            break;

                        case "image":

                            if(savemode){

                            let image = $("."+element.id+"zone");
                            let echelleimage = $("."+element.id+"echelle");
                            element.url = image.val();
                            element.echelle = parseFloat(echelleimage.val());
                            let toinsert = "";

                            }

                            // if echelle is undefined we set it to 1
                            if(element.echelle == undefined){
                                element.echelle = 1;
                            }

                            if(element.url == undefined){
                                element.url = "";
                            }

                            if (isValidHttpUrl(element.url) && element.echelle > 0) {
                                toinsert = `<img src="${element.url}" style="width: ${element.echelle * 100}%">`;
                            }else{
                                toinsert = `image non valide (ou echelle nul)`;
                            }


                            modulehtml += `<div class="module">
                                            <div class="module_header">
                                                <h3>Image</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>
                                            <div class="module_content">
                                                <div class="form-group">
                                                    <label for="image">Image</label>
                                                    <input type="text" value="${element.url}" class="form-control ${element.id}zone" id="image" placeholder="Lien de l'image">
                                                    Echelle de 1 = taille standard
                                                    <input type="text "value="${element.echelle}" class="form-control ${element.id}echelle" id="echelle" placeholder="Echelle de l'image">
                                                </div>
                                                <div class="${element.id}image">
                                                    ${toinsert}
                                                </div>
                                            </div>
                                        </div>`;

                            

                            
                         
                            break;

                        case "video":

                            if(savemode){

                            let video = $("."+element.id+"zone");
                            let echellevideo = $("."+element.id+"echelle");
                            element.url = video.val();
                            element.echelle = parseFloat(echellevideo.val());

                            }

                            // if echelle is undefined we set it to 1
                            if(element.echelle == undefined){
                                element.echelle = 1;
                            }

                            if(element.url == undefined){
                                element.url = "";
                            }

                            let toinsertvideo = "";


                            if (isValidHttpUrl(element.url) && element.echelle > 0) {
                                toinsertvideo = `<video width="${element.echelle * 100}" controls>
                                            <source src="${element.url}" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>`;
                            }else{
                                toinsertvideo = `video non valide (ou echelle nul)`;
                            }


                            modulehtml += `<div class="module">
                                            <div class="module_header">
                                                <h3>Video</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>
                                            <div class="module_content">
                                                <div class="form-group">
                                                    <label for="video">Video</label>
                                                    <input type="text" class="form-control ${element.id}zone" value="${element.url}" id="video" placeholder="Lien de la video">
                                                    <input type="text "value="${element.echelle}" class="form-control ${element.id}echelle" id="echelle" placeholder="Echelle de la video">
                                                </div>

                                                <div class="${element.id}video">
                                                    ${toinsertvideo}
                                                </div>

                                            </div>
                                        </div>`;

                                   
                            break;

                        

                        case "question_mot":

                            if(savemode){
                            let questionmot = $("."+element.id+"question");
                            let reponsemot = $("."+element.id+"reponse");
                            element.question = questionmot.val();
                            element.reponse_type = reponsemot.val();
                            }

                            if(element.reponse_type == undefined){
                                element.reponse_type = "";
                            }

                            if(element.question == undefined){
                                element.question = "";
                            }

                            modulehtml += `<div class="module question_mot">
                                <div class="module_header">
                                                <h3>Question mot</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                </div>
                                <div class="module_content">
                            <input type="text" class="form-control ${element.id}question" id="question" value="${element.question.replace(/\"/g,"\'\'")}" placeholder="Question">
                            <div class="reponse">
                            <input type="text" class="form-control ${element.id}reponse" id="reponse" value="${element.reponse_type.replace(/\"/g,"\'\'")}" placeholder="R√©ponse type">
                            </div>
                            </div>
                            </div>`;

                           
                            break;

                        case "question_ouverte":

                            if(savemode){

                            let questionouverte = $("."+element.id+"questionouverte");
                            let nb_ligne = $("."+element.id+"nbligne");
                            let reponse_type = $("."+element.id+"zone");
                            element.question = questionouverte.val();
                            element.nombre_lignes = parseFloat(nb_ligne.val());
                            element.reponse_type = reponse_type.val();

                            }

                            if(element.question == undefined){
                                element.question = "";
                            }

                            if(element.reponse_type == undefined){
                                element.reponse_type = "";
                            }


                            modulehtml += `<div class="module question_ouverte">

                                <div class="module_header">
                                                <h3>Question ouverte</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                </div>

                                <div class="module_content">

                            <div class="question">
                            <input type="text" class="form-control ${element.id}questionouverte" id="question" value="${element.question.replace(/\"/g,"\'\'")}" placeholder="Question ouverte">
                            </div>
                            <input type="number" class="${element.id}nbligne" value="${element.nombre_lignes}" name="quantity" min="1">
                            
                            <div class="reponsetype">
                            <textarea class="reponse_ouverte ${element.id}zone" placeholder="r√©ponse type">${element.reponse_type.replace(/\"/g,"\'\'")}</textarea>
                            </div>
                            </div>

                            </div>`;

                           
                            break;

                        case "texte_a_trous":

                            if(savemode){
                                let textatrous = $("."+element.id+"question");
                                let reponsetype = $("."+element.id+"propositions");
                                element.question = textatrous.val();
                                try{
                                element.reponse_type = reponsetype.val().split(";");
                                }catch(e){
                                    element.reponse_type = [];
                                }
                            }

                            //if propositions is undefined, set it to an empty array
                            if(element.reponse_type == undefined){
                                element.reponse_type = [];
                            }

                            if(element.question == undefined){
                                element.question = "";
                            }

                            if(element.reponse_type == undefined){
                                element.reponse_type = "";
                            }

                     
                        

                            modulehtml += `<div class="module texte_a_trous">

                                <div class="module_header">
                                                <h3>Texte √† trous</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>

                                            <div class="module_content">

                            <div class="question">
                                <input type="text" class="form-control ${element.id}question" id="question" value="${element.question.replace('"',"\'\'")}" placeholder="texte a trous : %s <- pour les trous">
                            </div>
                            <div class="reponsetype">
                                Chaque r√©ponse doit √™tre s√©par√©e par un point-virgule ";"
                                <input type="text" class="form-control ${element.id}propositions" id="proposition" value="${element.reponse_type.join(";").replace(/\"/g,"\'\'")}" placeholder="Propositions">
                            </div>
                            </div>
                            </div>`;

                          
                            break;

                        case "QCU":
                            if(savemode){
                                let questioncu = $("."+element.id+"question");
                                let propositionscu = $("."+element.id+"propositions");
                                let reponsetypecu = $("."+element.id+"reponse_type");
                                element.question = questioncu.val();
                                try{
                                element.propositions = propositionscu.val().split(";");
                                }catch(e){
                                element.propositions = [];
                                }
                                element.reponse_type = reponsetypecu.val();
                        }

                        if(element.question == undefined){
                                element.question = "";
                            }

                        if(element.propositions == undefined){
                                element.propositions = [];
                            }

                        if(element.reponse_type == undefined){
                                element.reponse_type = "";
                            }
                      

                            modulehtml += `<div class="module QCU">

                                <div class="module_header">
                                                <h3>QCU</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                </div>

                                <div class="module_content">


                                Question
                                <input type="text" class="form-control ${element.id}question" id="question" value="${element.question.replace(/\"/g,"\'\'")}" placeholder="Question">
                                Propositions (";" comme s√©parateur)
                                <input class="form-control ${element.id}propositions" id="proposition" value="${element.propositions.join(";").replace(/\"/g,"\'\'")}" placeholder="Propositions"></textarea>
                                R√©ponse Type (1 seule r√©ponse)
                                <input type="text" class="form-control ${element.id}reponse_type" id="reponse_type" value="${element.reponse_type.replace(/\"/g,"\'\'")}" placeholder="R√©ponse type">
                                </div>
                        
                            </div>`;

                            
                            break;

                        case "QCM":

                            if(savemode){

                            let questioncm = $("."+element.id+"question");
                            let propositionscm = $("."+element.id+"propositions");
                            let reponsetypecm = $("."+element.id+"reponse_type");
                            element.question = questioncm.val();
                            try{
                                element.propositions = propositionscm.val().split(";");
                            }catch(e){
                                    element.propositions = [];
                            }
                            element.reponse_type = reponsetypecm.val().split(";");
                            }
                        

                        if(element.reponse_type == undefined){
                            element.reponse_type = [];
                        }

                        if(element.propositions == undefined){
                            element.propositions = [];
                        }

                        

                        if(element.question == undefined){
                            element.question = "";
                        }

                


                    

                            modulehtml += `<div class="module QCM">

                                <div class="module_header">
                                                <h3>QCM</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                </div>
                                <div class="module_content">

                                Question
                                <input type="text" class="form-control ${element.id}question" id="question" value="${element.question.replace(/\"/g,"\'\'")}" placeholder="Question">
                                Propositions (";" comme s√©parateur)
                                <input class="form-control ${element.id}propositions" id="proposition" value="${element.propositions.join(";").replace(/\"/g,"\'\'")}" placeholder="Propositions"></textarea>
                                R√©ponse Type (";" comme s√©parateur)
                                <input type="text" class="form-control ${element.id}reponse_type" id="reponse_type" value="${element.reponse_type.join(";").replace(/\"/g,"\'\'")}" placeholder="R√©ponse type">
                                </div>
                            </div>`;

                            
                            break;

                        case "colonnes_a_remplir":
                        if(savemode){
                            let questioncol = $("."+element.id+"question");
                            let colonnes = $("."+element.id+"colonne");
                            let nblignes = $("."+element.id+"nbligne");
                            element.question = questioncol.val();
                            try{
                                element.colonnes = colonnes.val().split(";");
                            }catch(e){
                                element.colonnes = [];
                            }
                            element.nombre_lignes = parseFloat(nblignes.val());
                        }

                        if(element.question == undefined){
                            element.question = "";
                        }

                        if(element.nombre_lignes == undefined){
                            element.nombre_lignes = 1;
                        }

                        if(element.colonnes == undefined){
                            element.colonnes = [];
                        }
                            

                            modulehtml += `<div class="module colonnes_a_remplir">

                                <div class="module_header">
                                                <h3>Colonnes √† remplir</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>

                                <div class="module_content">
                                Question
                                <input type="text" class="form-control ${element.id}question" id="question" value="${element.question.replace(/\"/g,"\'\'")}" placeholder="Question">
                                Colonnes (";" comme s√©parateur)
                                <input class="form-control ${element.id}colonne" id="colonnes" value="${element.colonnes.join(";").replace(/\"/g,"\'\'")}" placeholder="Colonnes">
                                Nombre de lignes
                                <input type="number" class="${element.id}nbligne" value="${element.nombre_lignes}" name="quantity" min="1">
                                </div>

                            
                            </div>`;

                           
                            break;

                        case "dessin":
                        if(savemode){
                            let questiondessin = $("."+element.id+"question");
                            let urlfond = $("."+element.id+"url");
                            let reponsetypedessin = $("."+element.id+"reponse_type");
                            let echelledessin = $("."+element.id+"echelle");
                            element.question = questiondessin.val();
                            element.image_arriere_plan = urlfond.val();
                            element.reponse_type = reponsetypedessin.val();
                            element.echelle = echelledessin.val()/100;
                        }

                        let backimage = "";
                        //if the picture is valid , and the scale set , we draw it
                        if(isValidHttpUrl(element.image_arriere_plan) && element.echelle != 0){
                            backimage = `<img src="${element.image_arriere_plan}" style="width:${element.echelle*100}%;">`;
                        }

                        if(element.question == undefined){
                            element.question = "";
                        }

                        if(element.image_arriere_plan == undefined){
                            element.image_arriere_plan = "https://api.planet.ad1838.ovh/media/thumbnail/blank.webp";
                        }

                        if(element.reponse_type == undefined){
                            element.reponse_type = "";
                        }



                            modulehtml += `<div class="module dessin">

                                <div class="module_header">
                                                <h3>Dessin</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                </div>
                                <div class="module_content">

                                Question
                                <input type="text" class="form-control ${element.id}question" id="question" value="${element.question.replace(/\"/g,"\'\'")}" placeholder="Question">
                                Url image de fond
                                <input type="text" class="form-control ${element.id}url" id="url" value="${element.url}" placeholder="Url image de fond">
                                echelle de la figure (en %)
                                <input type="number" class="${element.id}echelle" value="${element.echelle*100}" name="quantity" min="1">
                                r√©ponse type (1 seule r√©ponse) (url)
                                <input type="text" class="form-control ${element.id}reponse_type" id="reponse_type" value="${element.reponse_type}" placeholder="R√©ponse type (URL)">
                                ${backimage}
                                </div>



                            </div>`;

                          
                            break;
                        
                        case "prise_photo":
                        if(savemode){
                            let questionphoto = $("."+element.id+"zone");
                            element.contenu = questionphoto.val();
                        }

                        if(element.contenu == undefined){
                            element.contenu = "";

                        }

                            modulehtml += `<div class="module prise_de_photo">

                                <div class="module_header">
                                                <h3>Prise de photo</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>

                                <div class="module_content">
                                Texte de la prise de photo
                                <input type="text" class="form-control ${element.id}zone" id="prisephoto" value="${element.contenu.replace(/\"/g,"\'\'")}" placeholder="Remarque">
                          
                                </div>
                            </div>`;

                           
                            break;

                        case "prise_video":
                        if(savemode){
                            let questionvideo = $("."+element.id+"zone");
                            element.contenu = questionvideo.val();
                        }

                        if(element.contenu == undefined){
                            element.contenu = "";

                        }

                            modulehtml += `<div class="module prise_video">

                                <div class="module_header">
                                                <h3>Prise vid√©o</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>
                                
                                <div class="module_content">

                                    Texte de la prise de vid√©o
                                    <input type="text" class="form-control ${element.id}zone" id="prisevideo" value="${element.contenu.replace(/\"/g,"\'\'")}" placeholder="Remarque">


                                    
                                </div>

               
                            </div>`;

                            
                            break;

                        case "question_magnetometre":
                        if(savemode){
                            let questionmagnetometre = $("."+element.id+"question");
                            let reponsetypemagnetometre = $("."+element.id+"reponse_type");
                            element.question = questionmagnetometre.val();
                            element.reponse_type = reponsetypemagnetometre.val();
                        }

                        if(element.question == undefined){
                            element.question = "";
                        }
                        if(element.reponse_type == undefined){
                            element.reponse_type = "";
                        }

                            modulehtml += `<div class="module question_magnetometre">
                                <div class="module_header">
                                                <h3>Question magnetom√®tre</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>
                                            <div class="module_content">
                                Question
                                <input type="text" class="form-control ${element.id}question" id="question" value="${element.question.replace(/\"/g,"\'\'")}" placeholder="Question">
                                R√©ponse type (1 seule r√©ponse) (url)
                                <input type="text" class="form-control ${element.id}reponse_type" id="reponse_type" value="${element.reponse_type.replace(/\"/g,"\'\'")}" placeholder="R√©ponse type (URL)">
                                </div>
                            </div>`;
                           
                            break;

                        case "question_deplacement":
                        if(savemode){
                            let questiondeplacement = $("."+element.id+"question");
                            let reponsetypedeplacement = $("."+element.id+"reponse_type");
                            element.question = questiondeplacement.val();
                            element.reponse_type = reponsetypedeplacement.val();
                        }

                        if(element.question == undefined){
                            element.question = "";
                        }

                        if(element.reponse_type == undefined){
                            element.reponse_type = "";
                        }

                            modulehtml += `<div class="module question_deplacement">
                                <div class="module_header">
                                                <h3>Question d√©placement</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>
                                            <div class="module_content">
                                Question
                                <input type="text" class="form-control ${element.id}question" id="question" value="${element.question.replace(/\"/g,"\'\'")}" placeholder="Question">
                                R√©ponse type (1 seule r√©ponse) (url)
                                <input type="text" class="form-control ${element.id}reponse_type" id="reponse_type" value="${element.reponse_type.replace(/\"/g,"\'\'")}" placeholder="R√©ponse type (URL)">
                                </div>
                            </div>`;
                           
                            break;
                        
                        case "question_gyroscope":
                        if(savemode){
                            let questiongyroscope = $("."+element.id+"question");
                            let reponsetypegyroscope = $("."+element.id+"reponse_type");
                            element.question = questiongyroscope.val();
                            element.reponse_type = reponsetypegyroscope.val();
                        }

                        if(element.question == undefined){
                            element.question = "";
                        }

                        if(element.reponse_type == undefined){
                            element.reponse_type = "";
                        }

                            modulehtml += `<div class="module question_gyroscope">
                                <div class="module_header">
                                                <h3>Question gyroscope</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>
                                            <div class="module_content">
                                Question
                                <input type="text" class="form-control ${element.id}question" id="question" value="${element.question.replace(/\"/g,"\'\'")}" placeholder="Question">
                                R√©ponse type (1 seule r√©ponse) (url)
                                <input type="text" class="form-control ${element.id}reponse_type" id="reponse_type" value="${element.reponse_type.replace(/\"/g,"\'\'")}" placeholder="R√©ponse type (URL)">
                                </div>
                            </div>`;
                           
                            break;

                        case "question_accelerometre":
                        if(savemode){
                            let questionaccelerometre = $("."+element.id+"question");
                            let reponsetypeaccelerometre = $("."+element.id+"reponse_type");
                            element.question = questionaccelerometre.val();
                            element.reponse_type = reponsetypeaccelerometre.val();
                        }

                        if(element.question == undefined){
                            element.question = "";
                        }
                        if(element.reponse_type == undefined){
                            element.reponse_type = "";
                        }
                            modulehtml += `<div class="module question_accelerometre">
                                <div class="module_header">
                                                <h3>Question accelerom√®tre</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>
                                            <div class="module_content">
                                Question
                                <input type="text" class="form-control ${element.id}question" id="question" value="${element.question.replace(/\"/g,"\'\'")}" placeholder="Question">
                                R√©ponse type (1 seule r√©ponse) (url)
                                <input type="text" class="form-control ${element.id}reponse_type" id="reponse_type" value="${element.reponse_type.replace(/\"/g,"\'\'")}" placeholder="R√©ponse type (URL)">
                                </div>
                            </div>`;
                           
                            break;

                        case "glisser_deposer_cible":
                            // question, image_arriere_plan, echelle, objets (liste)
                            if(savemode){
                                let questionglisserdeposercible = $("."+element.id+"question");
                                let imagearriereplanglisserdeposercible = $("."+element.id+"image_arriere_plan");
                                let echelleglisserdeposercible = $("."+element.id+"echelle");
                                let objetsglisserdeposercible = $("."+element.id+"objets");
                                element.question = questionglisserdeposercible.val();
                                element.image_arriere_plan = imagearriereplanglisserdeposercible.val();
                                element.echelle = parseFloat(echelleglisserdeposercible.val());
                                element.objets = objetsglisserdeposercible.val();
                            }

                            if(element.question == undefined){
                                element.question = "";
                            }
                            if(element.image_arriere_plan == undefined){
                                element.image_arriere_plan = "";
                            }
                            if(element.echelle == undefined){
                                element.echelle = 1;
                            }
                            modulehtml += `<div class="module glisser_deposer_cible">
                                <div class="module_header">
                                                <h3>Glisser d√©poser cible</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>
                                            <div class="module_content">
                                Question
                                <input type="text" class="form-control ${element.id}question" id="question" value="${element.question}" placeholder="Question">
                                Image arri√®re plan
                                <input type="text" class="form-control ${element.id}image_arriere_plan" id="image_arriere_plan" value="${element.image_arriere_plan}" placeholder="Image arri√®re plan">
                                Echelle
                                <input type="text" class="form-control ${element.id}echelle" id="echelle" value="${element.echelle}" placeholder="Echelle">
                                Objets (liste)
                                <textarea type="text" class="form-control ${element.id}objets" id="objets" value="${element.objets}" placeholder="Objets"></textarea>
                                </div>
                            </div>`;

                            break;

                        case "glisser_deposer_zone":
                            // question, image_arriere_plan, echelle, objets (liste)
                            if(savemode){
                                let questionglisserdeposerzone = $("."+element.id+"question");
                                let imagearriereplanglisserdeposerzone = $("."+element.id+"image_arriere_plan");
                                let echelleglisserdeposerzone = $("."+element.id+"echelle");
                                let objetsglisserdeposerzone = $("."+element.id+"objets");
                                element.question = questionglisserdeposerzone.val();
                                element.image_arriere_plan = imagearriereplanglisserdeposerzone.val();
                                element.echelle = parseFloat(echelleglisserdeposerzone.val());
                                element.objets = objetsglisserdeposerzone.val();
                            }

                            if(element.question == undefined){
                                element.question = "";
                            }
                            if(element.image_arriere_plan == undefined){
                                element.image_arriere_plan = "";
                            }
                            if(element.echelle == undefined){
                                element.echelle = 1;
                            }

                            modulehtml += `<div class="module glisser_deposer_zone">
                                <div class="module_header">
                                                <h3>Glisser d√©poser zone</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>
                                            <div class="module_content">
                                Question
                                <input type="text" class="form-control ${element.id}question" id="question" value="${element.question}" placeholder="Question">
                                Image arri√®re plan
                                <input type="text" class="form-control ${element.id}image_arriere_plan" id="image_arriere_plan" value="${element.image_arriere_plan}" placeholder="Image arri√®re plan">
                                Echelle
                                <input type="text" class="form-control ${element.id}echelle" id="echelle" value="${element.echelle}" placeholder="Echelle">
                                Objets (liste)
                                <textarea type="text" class="form-control ${element.id}objets" id="objets" value="${element.objets}" placeholder="Objets"></textarea>
                                </div>
                            </div>`;

                            break;

                        case "calculatrice":
                            modulehtml += `<div class="module calculatrice">
                                <div class="module_header">
                                                <h3>Calculatrice</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div> </div>`;
                           
                            break;
                        
                        case "chronometre":
                            modulehtml += `<div class="module chronometre">
                                <div class="module_header">
                                                <h3>Chronom√®tre</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div> </div>`;
                           
                            break;
                        
                        case "sondage":
                        if(savemode){
                            let questionsond = $("."+element.id+"question");
                            let propositionssond = $("."+element.id+"propositions");
                            element.question = questionsond.val();
                            try{
                            element.propositions = propositionssond.val().split(";");
                            }catch(e){
                                element.propositions = [];
                            }
                        }

                        if(element.propositions == undefined){
                            element.propositions = [];
                        }
                        if(element.question == undefined){
                            element.question = "";
                        }

                            modulehtml += `<div class="module sondage">
                                <div class="module_header">
                                                <h3>Sondage</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>
                                <div class="module_content">
                                    Question
                                    <input type="text" class="form-control ${element.id}question" id="question" value="${element.question.replace(/\"/g,"\'\'")}" placeholder="Question">


                                    Propositions (; comme s√©parateur)
                                    <input type="text" class="form-control ${element.id}propositions" id="propositions" value="${element.propositions.join(";").replace(/\"/g,"\'\'")}" placeholder="Propositions">


                                </div>
                            </div>`;

                            break;

                        case "resultat_sondage":
                            modulehtml += `<div class="module resultat_sondage">
                                <div class="module_header">
                                                <h3>R√©sultat du sondage</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                            </div> </div>`;

                            

                            break;

                        case "synthese":
                        if(savemode){
                            let question = $("."+element.id+"question");
                            let nbligne = $("."+element.id+"nomber_ligne");
                            element.question = question.val();
                            element.nombre_lignes = nbligne.val();
                        }

                        if(element.question == undefined){
                            element.question = "";
                        }
                        if(element.nombre_lignes == undefined){
                            element.nombre_lignes = 1;
                        }
                            
                            modulehtml += `<div class="module synthese">
                                <div class="module_header">
                                                <h3>Synth√®se</h3>
                                                <button class="btn btn-danger btn-sm delete_module" onclick="removeblock('${element.id}')"></button>
                                            </div>

                                <div class="module_content">
                                    Question
                                    <input type="text" class="form-control ${element.id}question" id="question" value="${element.question.replace(/\"/g,"\'\'")}" placeholder="Question">
                                    Nombre de lignes 
                                    <input type="number" class="form-control ${element.id}nombre_lignes" id="nombre_lignes" value="${element.nombre_lignes}" placeholder="Nombre de lignes">
                                </div>
                           
                           
                            </div>`;

                           
                            break;

                        case "newpage":
                            modulehtml += `<div class="pagetitle">Page n¬∞${pages}</div>
                            <button class="btn btn-danger btn-sm delete_module newpagedelete" onclick="removeblock('${element.id}')"></button>
                            
                            
                            `;
                            
                            pages++;
                           
                            break;

                        default:
                            
                            break;

                        }

                        

                        
                    
                });

                return modulehtml;


            }

            function download(){

                rendermodules(savemode=true);

                let nom_atelier = $("#nom_atelier").val();
                let version = $("#version").val();
                let image = $("#image").val();
                let description = $(".headerzone").val();
                let duree = $("#duree").val();
                let niveau_min = $("#niveau_min").val();

                let jsonpage = {
                    "nom_atelier": nom_atelier,
                    "version": version,
                    "image": image,
                    "description": description,
                    "duree": duree,
                    "niveau_min": niveau_min,
                    "pages": []
                };

                let modulelistcopy = JSON.parse(JSON.stringify(modulelist));

                modulelistcopy.forEach(element => {

                    delete element.id;

                });

                pagelist = [];
                accumulator = [];

                modulelistcopy.forEach(element => {

                    if(element.type_module == "newpage" && accumulator.length > 0){
                        pagelist.push({modules : accumulator});
                        accumulator = [];
                    }
                    else if (element.type_module != "newpage"){
                        accumulator.push(element);
                    }


                });

                pagelist.push({modules : accumulator});

                jsonpage.pages = pagelist;
                   
                let jsonstring = JSON.stringify(jsonpage);

                let blob = new Blob([jsonstring], {type: "application/json"});
                let url = URL.createObjectURL(blob);
                let link = document.createElement("a");
                link.href = url;
                link.download = `${jsonpage.nom_atelier}.json`;
                link.click();

            }

            function isValidHttpUrl(string) {
                var urlRegex = /^(http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?$/;
                return urlRegex.test(string);
             }


            addpage();

            // When someone chose a file (file-selector), it's loaded and rendered
            $("#file-selector").on("change", function(e) {

                loadjson();
                console.log("file changed");
               
            }
            );

            // Change the attribute of the page for the attribute in the json file loaded by the user (with file-selector)
            function loadjson(){
                    
                    let file = $("#file-selector")[0].files[0];
                    let reader = new FileReader();
                    reader.onload = function(e) {
                        let json = JSON.parse(e.target.result);
                        
                        $("#nom_atelier").val(json.nom_atelier);
                        $("#version").val(json.version);
                        $("#image").val(json.image);
                        $(".headerzone").val(json.description);
                        $("#duree").val(json.duree);
                        $("#niveau_min").val(json.niveau_min);
                        let pagelist = json.pages;
                        
                        modulelist.forEach(element => {
                            delete element;
                        });

                        let pagestart = false;

                        
                        pagelist.forEach(element => {
                            maxid++;
                            if(pagestart){
                            modulelist.push({type_module : "newpage", id : maxid});
                            }
                            pagestart = true;
                            element.modules.forEach(element => {
                                maxid++;
                                element.id = maxid;
                                modulelist.push(element);
                            });
                        });

                        let renderedmodules =  rendermodules(savemode=false);
                        $("#modulebody").html(renderedmodules);
                      
                    }
                    reader.readAsText(file);

                    
            }



    </script>

    

    <div id="modulebody">


    </div>

    <input type="button" class="download" value="Download Json" onclick="download()"/>

</div>
    


</body>
</html>